<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Syncing 2</title>

    <link rel="stylesheet" type="text/css" href="/css/style.css" />

    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/lib/three.min.js"></script>
    <script src="/js/lib/physi.js"></script>
    <script>
        Physijs.scripts.worker = '/js/lib/physijs_worker.js';
        Physijs.scripts.ammo   = '/js/lib/ammo.js';
    </script>
    <script src="/js/basic.js"></script>
    <script src="/js/scene.js"></script>
    <script src="/js/ui.js"></script>
    <script type="text/babel">

    const randRange = (min, max) => Math.random() * (max - min) + min;

    const aVal = 'A'.charCodeAt(), zVal = 'Z'.charCodeAt();
    const getRandomChar = () => String.fromCharCode(randRange(aVal, zVal + 1) | 0);
    const getName = () => getRandomChar() + getRandomChar() + getRandomChar();
    
    const hexShift = (val, amt) => val << ((4 * amt) | 0);
    const randColor = () => hexShift(randRange(0,256) | 0, 4) + hexShift(randRange(0,256) | 0, 2) + (randRange(0,256) | 0);

    const getVector3 = (obj) => new THREE.Vector3(obj.x, obj.y, obj.z);

    let socket;
    let name;

    const init = () => {
        socket = io.connect();

        socket.on('add', data => {
            let player = new Player(data.player.name, data.player.color, data.player.position);
            player.lastUpdate = data.time;
            player.instantiate();
        })

        socket.on('update', (data) => {
            if(Object.hasOwnProperty.call(players, data.name) && data.time > players[data.name].lastUpdate) {
                players[data.name].lastUpdate = data.time;
                
                const go = players[data.name].gameObject;
                go.position.set(data.position.x, data.position.y, data.position.z);
                go.rotation.set(data.rotation.x, data.rotation.y, data.rotation.z);
                go.__dirtyPosition = go.__dirtyRotation = true;

                go.setLinearVelocity(getVector3(data.linearVelocity));
                go.setAngularVelocity(getVector3(data.angularVelocity));
            }
        });

        socket.on('lose', (data) => {
            if(Object.hasOwnProperty.call(players, data)) {
                console.log(`${data} lost`);
                players[data].destroy();
            }
        });

        socket.on('win', (data) => {
            console.log(`Winner! ${data}`);
        });

        socket.on('gameOver', (data) => {
            console.log(`Game over.`);
            for(let player in players)
                players[player].destroy();
        });

        window.addEventListener('keydown', (e) => inputs[e.keyCode] = true);
        window.addEventListener('keyup',   (e) => inputs[e.keyCode] = false);

        const playerUpdate = function() {
            let dir = new THREE.Vector3(0,0,0);
            if(inputs[87]) dir.z -= 1; // w
            if(inputs[83]) dir.z += 1; // s
            if(inputs[68]) dir.x += 1; // d
            if(inputs[65]) dir.x -= 1; // a

            const moved = dir.x || dir.z
            let input = { direction: dir };
            if(moved) {
                dir.setLength(50);
                socket.emit('input', { name, input });
            }

            this.updateDirection(input);
        };

        scene.scene.addEventListener('update', () => {
            for(let playerName in players) 
                players[playerName].update();
        })

        let joinData = { 
            name:  getName()
          , color: randColor()
          , position: new THREE.Vector3(
              randRange(-5, 5), 5, randRange(-5, 5)
            ) 
        };
        socket.on('connectFail', () => {
            joinData.name = getName;
            socket.emit('join', joinData);
        });
        socket.on('connectSuccess', () => {
            name = joinData.name;
            const player = new Player(joinData.name, joinData.color, joinData.position);
            player.customUpdate = playerUpdate.bind(player);
            player.instantiate();
        });

        socket.emit('join', joinData);
    };

    window.onload = init;
    </script>
</head>
<body>
    <canvas style="border: 2px solid black">Dumb browser, get a new one</canvas>
    <div id="pop_ups"></div>
    <h3 style="position: absolute; top: 20px; left: 20px">WASD to move</h3>
</body>
</html>
